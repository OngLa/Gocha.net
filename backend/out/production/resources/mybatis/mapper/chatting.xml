<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kosa.afnica.backend.db.mapper.ChattingMapper">

    <!--  정비소 목록 조회  -->
    <select id="findAllCarcenter" resultType="ChattingResDto">
        SELECT ID, NAME
        FROM MEMBER
        WHERE ROLE = 'ROLE_CARCENTER'
          AND enabled = '1'
    </select>

    <!--  나에게 메세지 보낸 고객 id 조회  -->
    <select id="findSendUser" parameterType="Long" resultType="Long">
        SELECT USER_ID
        FROM CHATTING
        WHERE CARCENTER_ID = #{memberId}
    </select>

    <!--  나에게 메세지 보낸 고객들 정보 조회  -->
    <select id="findAllUser" parameterType="java.util.List" resultType="ChattingResDto">
        SELECT ID, NAME
        FROM MEMBER
        WHERE ID IN
        <foreach collection="list" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
        AND ENABLED = 1
    </select>

    <!--  해당 카센터의 정보 찾기  -->
    <select id="findCarcenterInfo" parameterType="Long" resultType="CarcenterInfoResDto">
        SELECT PHONE_NUMBER, EMAIL, ADDRESS
        FROM MEMBER
        WHERE ID = #{carcenterId}
    </select>

    <!--  채팅방 Id 찾기  -->
    <select id="findChatroom" parameterType="map" resultType="Long">
        SELECT ID
        FROM CHATTING
        WHERE USER_ID = #{userId}
          AND CARCENTER_ID = #{carcenterId}
    </select>

    <!--  채팅방 생성  -->
    <insert id="saveChatroom" parameterType="map">
        <selectKey keyProperty="id" resultType="Long" order="BEFORE">
            SELECT CHATTING_SEQ.nextval FROM DUAL
        </selectKey>
        INSERT INTO CHATTING (ID, CREATE_DATE, CARCENTER_ID, USER_ID)
        VALUES (#{id}, #{createDate}, #{carcenterId}, #{userId})
    </insert>

    <!--  해당 채팅방 메세지 찾기  -->
    <select id="findAllMessageByChatroomId" parameterType="Long" resultType="MessageResDto">
        SELECT ID, member_id, send_date, title, content, is_reservation, cardata_id
        FROM MESSAGE
        WHERE CHATTING_ID = #{chattingId}
        ORDER BY send_date ASC
    </select>

    <!--  CardataId로 cardata 불러오기  -->
    <select id="findCarDataByCarId" parameterType="Long" resultType="carData">
        SELECT ID,
               CAN_GO_DISTANCE,
               DISTANCE,
               CAR_BATTERY,
               BATTERY_CHARGE,
               BREAK_OIL,
               ENGINE_OIL,
               OIL,
               TIRE,
               WASHER,
               LAMP_WIRE,
               LAST_UPDATE,
               CAR_ID
        FROM CAR_DATA
        WHERE ID = #{cardataId}
    </select>

    <!--  글 작성 시 본인차 찾기  -->
    <select id="findAllCarByMemberId" parameterType="Long" resultType="ChattingCarResDto">
        SELECT id, car_number
        FROM CAR
        WHERE member_id = #{memberId}
        ORDER BY car_number
    </select>

    <!--  글 작성 시 본인 데이터 찾기  -->
    <select id="findAllCarDataByMemberId" parameterType="Long" resultType="ChattingCarDataResDto">
        SELECT A.id AS car_id, B.id, B.last_update
        FROM car A
                 INNER JOIN car_data B ON A.id = B.car_id
        WHERE member_id = #{memberId}
        ORDER BY B.last_update DESC
    </select>

    <!--  메세지 삽입  -->
    <insert id="saveMessage" parameterType="SendMessageReqDto">
        INSERT INTO MESSAGE(ID, CONTENT, is_reservation, SEND_DATE, TITLE, CARDATA_ID, CHATTING_ID, MEMBER_ID)
        VALUES (MESSAGE_SEQ.nextval, #{content}, #{isReservation}, #{sendDate}, #{title}, #{cardataId}, #{chattingId},
                #{memberId})
    </insert>
</mapper>