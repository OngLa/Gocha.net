<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kosa.afnica.backend.db.mapper.CarDataMapper">

    <!--  자동차 데이터 DB에 저장하기  -->
    <insert id="saveCarData" parameterType="carData">
        <selectKey keyProperty="id" resultType="Long" order="BEFORE">
            SELECT CAR_DATA_SEQ.nextval FROM DUAL
        </selectKey>
        INSERT INTO CAR_DATA
        (ID, BATTERY_CHARGE, BREAK_OIL, CAN_GO_DISTANCE, CAR_BATTERY, DISTANCE, ENGINE_OIL, LAMP_WIRE, LAST_UPDATE, OIL, TIRE, WASHER, CAR_ID)
        VALUES
        (#{id}, #{batteryCharge}, #{breakOil}, #{canGoDistance}, #{carBattery}, #{distance}, #{engineOil}, #{lampWire}, SYSDATE, #{oil}, #{tire}, #{washer}, #{carId})
    </insert>

    <!--  자동차 데이터 DB에 업데이트  -->
    <update id="updateCarData" parameterType="carData">
        UPDATE CAR_DATA
        SET BATTERY_CHARGE=#{batteryCharge},
            BREAK_OIL=#{breakOil},
            CAN_GO_DISTANCE=#{canGoDistance},
            CAR_BATTERY=#{carBattery},
            DISTANCE=#{distance},
            ENGINE_OIL=#{engineOil},
            LAMP_WIRE=#{lampWire},
            LAST_UPDATE=SYSDATE,
            OIL=#{oil},
            TIRE=#{tire},
            WASHER=#{washer}
        WHERE ID = #{id}
    </update>

    <!--  CarId, 오늘 날짜 기반 DB에 저장된 값이 있는지 조회  -->
    <select id="findByCarIdAndLastUpdate" parameterType="Long" resultType="carData">
        SELECT ID, BATTERY_CHARGE, BREAK_OIL, CAN_GO_DISTANCE, CAR_BATTERY, DISTANCE, ENGINE_OIL, LAMP_WIRE, LAST_UPDATE, OIL, TIRE, WASHER, CAR_ID
        FROM CAR_DATA
        WHERE CAR_ID = #{carId}
          AND TRUNC(LAST_UPDATE) = TRUNC(SYSDATE)
    </select>

    <!--  CarId 기반으로 모든 자동차 데이터 불러오기  -->
    <select id="findRecentCarDataByCarId" resultType="carData">
        SELECT ID,
               CAN_GO_DISTANCE,
               DISTANCE,
               CAR_BATTERY,
               BATTERY_CHARGE,
               BREAK_OIL,
               ENGINE_OIL,
               OIL,
               TIRE,
               WASHER,
               LAMP_WIRE,
               LAST_UPDATE,
               CAR_ID
        FROM CAR_DATA
        WHERE CAR_ID = #{carId}
        ORDER BY LAST_UPDATE DESC
            FETCH FIRST 1 ROW ONLY
    </select>

    <!--  CarId 기반으로 모든 자동차 데이터 불러오기  -->
    <select id="findAllCarDataByCarId" parameterType="carDataReqDto" resultType="carData">
        <![CDATA[
        SELECT ID,
               CAN_GO_DISTANCE,
               DISTANCE,
               CAR_BATTERY,
               BATTERY_CHARGE,
               BREAK_OIL,
               ENGINE_OIL,
               OIL,
               TIRE,
               WASHER,
               LAMP_WIRE,
               LAST_UPDATE,
               CAR_ID
        FROM CAR_DATA
        WHERE CAR_ID = #{carId}
          AND (#{startDate} IS NULL OR LAST_UPDATE >= #{startDate})
          AND (#{endDate} IS NULL OR LAST_UPDATE <= #{endDate})
        ORDER BY LAST_UPDATE DESC
        ]]>
    </select>

</mapper>